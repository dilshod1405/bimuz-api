# NOTE: This file is maintained in parallel with api_docs.txt
#       Both files contain the same information in different formats.
#       When updating API documentation, please update both files.

api:
  name: "BIMUZ API"
  version: "1.0"
  base_url: "/api/v1/"
  documentation_format: "YAML"

interactive_documentation:
  swagger_ui:
    url: "http://localhost:8000/swagger/"
    description: "Interactive API documentation with 'Try it out' functionality"
    features:
      - "Test endpoints directly from the browser"
      - "View request/response schemas"
      - "Authenticate using JWT Bearer tokens"
  
  redoc:
    url: "http://localhost:8000/redoc/"
    description: "Beautiful, responsive API documentation"
    features:
      - "Clean, readable documentation"
      - "Search functionality"
  
  openapi_schema:
    json: "http://localhost:8000/swagger.json"
    yaml: "http://localhost:8000/swagger.yaml"
    description: "Machine-readable OpenAPI 3.0 schema for API clients"
  
  note: "Replace localhost:8000 with your actual server domain in production."

authentication:
  type: "JWT Bearer Token"
  header: "Authorization: Bearer <access_token>"
  access_token_lifetime: "1 hour"
  refresh_token_lifetime: "7 days"
  token_rotation: true
  description: |
    All protected endpoints require JWT authentication. Include the access token
    in the Authorization header. Access tokens expire after 1 hour. Use the
    refresh token endpoint to get a new access token. Refresh tokens expire
    after 7 days and are automatically rotated on use.

endpoints:
  employee_authentication:
    registration:
      method: "POST"
      path: "/api/v1/auth/register/"
      authentication_required: false
      description: "Register a new employee account with user and employee profile"
      
      headers:
        Content-Type: "application/json"
      
      request_body:
        type: "object"
        required_fields:
          - email
          - first_name
          - last_name
          - password
          - password_confirm
          - full_name
          - role
        conditional_fields:
          speciality_id:
            condition: "Required only if role='mentor'"
            options:
              - "revit_architecture"
              - "revit_structure"
              - "tekla_structure"
            note: "Must be null/empty for non-mentor roles"
        optional_fields:
          - avatar
        schema:
          email:
            type: "string"
            format: "email"
            max_length: null
            unique: true
            description: "Valid email address (unique)"
          first_name:
            type: "string"
            max_length: 150
            description: "Employee's first name"
          last_name:
            type: "string"
            max_length: 150
            description: "Employee's last name"
          password:
            type: "string"
            write_only: true
            description: "Password (must pass Django password validators)"
          password_confirm:
            type: "string"
            write_only: true
            description: "Password confirmation (must match password)"
          full_name:
            type: "string"
            max_length: 255
            description: "Employee's full name"
          role:
            type: "string"
            enum:
              - "dasturchi"
              - "direktor"
              - "administrator"
              - "sotuv_agenti"
              - "mentor"
              - "assistent"
            description: "Employee role"
          speciality_id:
            type: "string"
            enum:
              - "revit_architecture"
              - "revit_structure"
              - "tekla_structure"
            nullable: true
            description: "Speciality (required only for mentors)"
          avatar:
            type: "file"
            nullable: true
            description: "Image file (upload via multipart/form-data)"
      
      example_request:
        email: "employee@example.com"
        first_name: "John"
        last_name: "Doe"
        password: "SecurePassword123!"
        password_confirm: "SecurePassword123!"
        full_name: "John Doe"
        role: "mentor"
        speciality_id: "revit_architecture"
        avatar: null
      
      success_response:
        status_code: 201
        description: "Employee registered successfully"
        schema:
          success: true
          message: "Employee registered successfully."
          data:
            employee:
              id: 1
              email: "employee@example.com"
              first_name: "John"
              last_name: "Doe"
              full_name: "John Doe"
              role: "mentor"
              role_display: "Mentor"
              speciality_id: "revit_architecture"
              speciality_display: "Revit Architecture"
              avatar: null
              avatar_url: null
              created_at: "2026-01-10T12:00:00Z"
              updated_at: "2026-01-10T12:00:00Z"
            tokens:
              refresh: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
              access: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
      
      error_responses:
        - status_code: 400
          description: "Validation errors"
          schema:
            success: false
            message: "Validation error"
            errors:
              email: ["Employee with this email already exists."]
              password_confirm: ["Passwords do not match."]
              speciality_id: ["Speciality is required for Mentors."]
      
      validation_rules:
        - "Email must be unique across all users"
        - "Password must meet Django's password validation requirements"
        - "Password and password_confirm must match"
        - "If role is 'mentor', speciality_id is required"
        - "If role is not 'mentor', speciality_id must be null/empty"

    login:
      method: "POST"
      path: "/api/v1/auth/login/"
      authentication_required: false
      description: "Authenticate an employee and receive JWT tokens"
      
      headers:
        Content-Type: "application/json"
      
      request_body:
        type: "object"
        required_fields:
          - email
          - password
        schema:
          email:
            type: "string"
            format: "email"
            description: "Valid email address of registered employee"
          password:
            type: "string"
            write_only: true
            description: "User's password"
      
      example_request:
        email: "employee@example.com"
        password: "SecurePassword123!"
      
      success_response:
        status_code: 200
        description: "Login successful"
        schema:
          success: true
          message: "Login successful."
          data:
            employee:
              id: 1
              email: "employee@example.com"
              first_name: "John"
              last_name: "Doe"
              full_name: "John Doe"
              role: "mentor"
              role_display: "Mentor"
              speciality_id: "revit_architecture"
              speciality_display: "Revit Architecture"
              avatar: "/media/avatars/employees/avatar.jpg"
              avatar_url: "http://example.com/media/avatars/employees/avatar.jpg"
              created_at: "2026-01-10T12:00:00Z"
              updated_at: "2026-01-10T12:00:00Z"
            tokens:
              refresh: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
              access: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
      
      error_responses:
        - status_code: 400
          description: "Invalid credentials or no employee profile"
          schema:
            success: false
            message: "Validation error"
            errors:
              email: ["Invalid email or password."]
        - status_code: 400
          description: "No employee profile found"
          schema:
            success: false
            message: "Validation error"
            errors:
              email: ["No employee profile found for this user."]
      
      notes:
        - "For security reasons, the same error message is returned for both invalid email and invalid password to prevent user enumeration."

    profile_get:
      method: "GET"
      path: "/api/v1/auth/profile/"
      authentication_required: true
      description: "Retrieve the authenticated employee's profile information"
      
      headers:
        Authorization: "Bearer <access_token>"
        Content-Type: "application/json"
      
      success_response:
        status_code: 200
        description: "Employee profile retrieved successfully"
        schema:
          success: true
          message: "Employee profile retrieved successfully."
          data:
            id: 1
            email: "employee@example.com"
            first_name: "John"
            last_name: "Doe"
            full_name: "John Doe"
            role: "mentor"
            role_display: "Mentor"
            speciality_id: "revit_architecture"
            speciality_display: "Revit Architecture"
            avatar: "/media/avatars/employees/avatar.jpg"
            avatar_url: "http://example.com/media/avatars/employees/avatar.jpg"
            created_at: "2026-01-10T12:00:00Z"
            updated_at: "2026-01-10T12:00:00Z"
      
      error_responses:
        - status_code: 401
          description: "Missing or invalid token"
          schema:
            detail: "Authentication credentials were not provided."
        - status_code: 404
          description: "Employee profile not found"
          schema:
            detail: "Employee profile not found."

    profile_update:
      method: "PATCH"
      path: "/api/v1/auth/profile/"
      authentication_required: true
      description: "Update the authenticated employee's profile (partial update allowed)"
      
      headers:
        Authorization: "Bearer <access_token>"
        Content-Type: "application/json (or multipart/form-data for avatar upload)"
      
      request_body:
        type: "object"
        all_fields_optional: true
        allowed_fields:
          - full_name
          - speciality_id
          - avatar
        read_only_fields:
          - id
          - email
          - first_name
          - last_name
          - role
          - created_at
          - updated_at
        schema:
          full_name:
            type: "string"
            max_length: 255
            description: "Employee's full name"
          speciality_id:
            type: "string"
            enum:
              - "revit_architecture"
              - "revit_structure"
              - "tekla_structure"
            description: "Speciality (only if role is 'mentor')"
          avatar:
            type: "file"
            description: "Image file (use multipart/form-data)"
      
      example_request:
        full_name: "John Updated Doe"
        speciality_id: "revit_structure"
      
      validation_rules:
        - "If role is 'mentor', speciality_id can be updated but cannot be removed"
        - "If role is not 'mentor', speciality_id cannot be set"
      
      success_response:
        status_code: 200
        description: "Employee profile updated successfully"
        schema:
          success: true
          message: "Employee profile updated successfully."
          data:
            id: 1
            email: "employee@example.com"
            first_name: "John"
            last_name: "Doe"
            full_name: "John Updated Doe"
            role: "mentor"
            role_display: "Mentor"
            speciality_id: "revit_structure"
            speciality_display: "Revit Structure"
            avatar: "/media/avatars/employees/new_avatar.jpg"
            avatar_url: "http://example.com/media/avatars/employees/new_avatar.jpg"
            created_at: "2026-01-10T12:00:00Z"
            updated_at: "2026-01-10T13:30:00Z"
      
      error_responses:
        - status_code: 400
          description: "Validation errors"
          schema:
            success: false
            message: "Validation error"
            errors:
              speciality_id: ["Speciality is required for Mentors."]
        - status_code: 401
          description: "Missing or invalid token"
        - status_code: 404
          description: "Employee profile not found"

    token_refresh:
      method: "POST"
      path: "/api/v1/auth/token/refresh/"
      authentication_required: false
      description: "Get a new access token using a refresh token"
      note: |
        When a refresh token is used, it is automatically rotated (blacklisted)
        and a new refresh token should be stored. However, this endpoint only
        returns the new access token. Use the login endpoint if you need both
        tokens.
      
      headers:
        Content-Type: "application/json"
      
      request_body:
        type: "object"
        required_fields:
          - refresh
        schema:
          refresh:
            type: "string"
            description: "Valid refresh token string"
      
      example_request:
        refresh: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
      
      success_response:
        status_code: 200
        description: "New access token generated"
        schema:
          access: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
      
      error_responses:
        - status_code: 401
          description: "Invalid or expired refresh token"
          schema:
            detail: "Token is invalid or expired"
            code: "token_not_valid"

  student_authentication:
    registration:
      method: "POST"
      path: "/api/v1/auth/students/register/"
      authentication_required: false
      description: "Talaba ro'yxatdan o'tkazish va shartnoma PDF yaratish"
      
      headers:
        Content-Type: "application/json"
      
      request_body:
        type: "object"
        required_fields:
          - email
          - password
          - password_confirm
          - full_name
          - phone
          - passport_serial_number
          - birth_date
          - source
        schema:
          email:
            type: "string"
            format: "email"
            unique: true
            description: "Valid email address (unique)"
          password:
            type: "string"
            write_only: true
            description: "Password (must pass Django password validators)"
          password_confirm:
            type: "string"
            write_only: true
            description: "Password confirmation (must match password)"
          full_name:
            type: "string"
            max_length: 255
            description: "Student's full name"
          phone:
            type: "string"
            max_length: 17
            pattern: "^\\+?1?\\d{9,13}$"
            unique: true
            description: "Phone number in format '+999999999', max 13 digits"
          passport_serial_number:
            type: "string"
            max_length: 20
            unique: true
            description: "Passport serial number"
          birth_date:
            type: "string"
            format: "date"
            description: "Birth date in format YYYY-MM-DD"
          source:
            type: "string"
            enum: ["instagram", "facebook", "telegram"]
            description: "Source of information about the course"
      
      example_request:
        email: "student@example.com"
        password: "SecurePassword123!"
        password_confirm: "SecurePassword123!"
        full_name: "Ali Valiyev"
        phone: "+998901234567"
        passport_serial_number: "AB1234567"
        birth_date: "2000-01-15"
        source: "instagram"
      
      success_response:
        status_code: 201
        description: "Talaba muvaffaqiyatli ro'yxatdan o'tdi. Shartnoma yaratildi. Tasdiqlash kodi SMS orqali yuborildi."
        schema:
          success: true
          message: "Talaba muvaffaqiyatli ro'yxatdan o'tdi. Shartnoma yaratildi. Tasdiqlash kodi SMS orqali yuborildi."
          data:
            student:
              id: 1
              email: "student@example.com"
              first_name: "Ali"
              last_name: "Valiyev"
              full_name: "Ali Valiyev"
              phone: "+998901234567"
              passport_serial_number: "AB1234567"
              birth_date: "2000-01-15"
              source: "instagram"
              source_display: "Instagram"
              group: null
              certificate: null
              contract: "/media/contracts/contract_1_20260110.pdf"
              contract_url: "http://localhost:8000/media/contracts/contract_1_20260110.pdf"
              contract_signed: false
              created_at: "2026-01-10T12:00:00Z"
              updated_at: "2026-01-10T12:00:00Z"
            tokens:
              refresh: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
              access: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
            sms_sent: true
            verification_code: "123456"  # Only included if SMS sending failed or for test accounts
      
      error_responses:
        - status_code: 400
          description: "Validation errors"
          schema:
            success: false
            message: "Validation error"
            errors:
              email: ["Bu email bilan foydalanuvchi allaqachon mavjud."]
              phone: ["Bu telefon raqami allaqachon ro'yxatdan o'tgan."]
              passport_serial_number: ["Bu passport seriya raqami allaqachon ro'yxatdan o'tgan."]
              password_confirm: ["Parollar mos kelmaydi."]
      
      validation_rules:
        - "Email must be unique across all users"
        - "Phone must be unique"
        - "Passport serial number must be unique"
        - "Password must meet Django's password validation requirements"
        - "Password and password_confirm must match"
        - "Contract PDF is automatically generated upon registration"
      
      notes:
        - "Ro'yxatdan o'tganda avtomatik ravishda shartnoma PDF fayli yaratiladi va talaba profili bilan bog'lanadi"
        - "Ro'yxatdan o'tgandan keyin 6 raqamli tasdiqlash kodi SMS orqali yuboriladi"
        - "Kod 2 daqiqa (yoki sozlangan vaqt) davomida amal qiladi"
        - "Test akkauntlar uchun kod API javobida ham qaytarilishi mumkin (verification_code maydoni)"

    login:
      method: "POST"
      path: "/api/v1/auth/students/login/"
      authentication_required: false
      description: "Talabani autentifikatsiya qilish va JWT tokenlarni olish"
      
      headers:
        Content-Type: "application/json"
      
      request_body:
        type: "object"
        required_fields:
          - email
          - password
        schema:
          email:
            type: "string"
            format: "email"
            description: "Student's email address"
          password:
            type: "string"
            write_only: true
            description: "Student's password"
      
      example_request:
        email: "student@example.com"
        password: "SecurePassword123!"
      
      success_response:
        status_code: 200
        description: "Kirish muvaffaqiyatli."
        schema:
          success: true
          message: "Kirish muvaffaqiyatli."
          data:
            student:
              id: 1
              email: "student@example.com"
              first_name: "Ali"
              last_name: "Valiyev"
              full_name: "Ali Valiyev"
              phone: "+998901234567"
              passport_serial_number: "AB1234567"
              birth_date: "2000-01-15"
              source: "instagram"
              source_display: "Instagram"
              group: null
              certificate: null
              contract: "/media/contracts/contract_1_20260110.pdf"
              contract_url: "http://localhost:8000/media/contracts/contract_1_20260110.pdf"
              created_at: "2026-01-10T12:00:00Z"
              updated_at: "2026-01-10T12:00:00Z"
            tokens:
              refresh: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
              access: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
      
      error_responses:
        - status_code: 400
          description: "Invalid credentials"
          schema:
            success: false
            message: "Validation error"
            errors:
              email: ["Noto'g'ri email yoki parol."]

    get_profile:
      method: "GET"
      path: "/api/v1/auth/students/profile/"
      authentication_required: true
      description: "Autentifikatsiya qilingan talabaning profil ma'lumotlarini olish"
      
      headers:
        Authorization: "Bearer <access_token>"
      
      success_response:
        status_code: 200
        description: "Talaba profili muvaffaqiyatli yuklandi."
        schema:
          success: true
          message: "Talaba profili muvaffaqiyatli yuklandi."
          data:
            id: 1
            email: "student@example.com"
            first_name: "Ali"
            last_name: "Valiyev"
            full_name: "Ali Valiyev"
            phone: "+998901234567"
            passport_serial_number: "AB1234567"
            birth_date: "2000-01-15"
            source: "instagram"
            source_display: "Instagram"
            group: null
            certificate: null
            contract: "/media/contracts/contract_1_20260110.pdf"
            contract_url: "http://localhost:8000/media/contracts/contract_1_20260110.pdf"
            created_at: "2026-01-10T12:00:00Z"
            updated_at: "2026-01-10T12:00:00Z"
      
      error_responses:
        - status_code: 401
          description: "Authentication required"
        - status_code: 404
          description: "Student profile not found"

    update_profile:
      method: "PATCH"
      path: "/api/v1/auth/students/profile/"
      authentication_required: true
      description: "Autentifikatsiya qilingan talabaning profilini yangilash (qisman yangilash mumkin)"
      
      headers:
        Authorization: "Bearer <access_token>"
        Content-Type: "application/json (or multipart/form-data for file uploads)"
      
      request_body:
        type: "object"
        optional_fields:
          - full_name
          - phone
          - certificate
        schema:
          full_name:
            type: "string"
            max_length: 255
            description: "Student's full name"
          phone:
            type: "string"
            max_length: 17
            pattern: "^\\+?1?\\d{9,13}$"
            unique: true
            description: "Phone number in format '+999999999', max 13 digits"
          certificate:
            type: "file"
            description: "Certificate file (upload via multipart/form-data)"
      
      example_request:
        full_name: "Ali Valiyev O'g'li"
        phone: "+998901234568"
      
      success_response:
        status_code: 200
        description: "Talaba profili muvaffaqiyatli yangilandi."
        schema:
          success: true
          message: "Talaba profili muvaffaqiyatli yangilandi."
          data:
            id: 1
            email: "student@example.com"
            first_name: "Ali"
            last_name: "Valiyev"
            full_name: "Ali Valiyev O'g'li"
            phone: "+998901234568"
            passport_serial_number: "AB1234567"
            birth_date: "2000-01-15"
            source: "instagram"
            source_display: "Instagram"
            group: null
            certificate: null
            contract: "/media/contracts/contract_1_20260110.pdf"
            contract_url: "http://localhost:8000/media/contracts/contract_1_20260110.pdf"
            created_at: "2026-01-10T12:00:00Z"
            updated_at: "2026-01-10T12:00:00Z"
      
      error_responses:
        - status_code: 400
          description: "Validation errors"
        - status_code: 401
          description: "Authentication required"
        - status_code: 404
          description: "Student profile not found"
      
      note: "Email, passport_serial_number, birth_date, source cannot be updated after registration"

    verify_contract:
      method: "POST"
      path: "/api/v1/auth/students/verify-contract/"
      authentication_required: true
      description: "Shartnomani elektron imzo bilan tasdiqlash uchun SMS orqali yuborilgan kodni tekshirish"
      
      headers:
        Authorization: "Bearer <access_token>"
        Content-Type: "application/json"
      
      request_body:
        type: "object"
        required_fields:
          - verification_code
        schema:
          verification_code:
            type: "string"
            min_length: 6
            max_length: 6
            pattern: "^[0-9]{6}$"
            description: "6-digit verification code sent via SMS"
      
      example_request:
        verification_code: "123456"
      
      success_response:
        status_code: 200
        description: "Shartnoma muvaffaqiyatli tasdiqlandi."
        schema:
          success: true
          message: "Shartnoma muvaffaqiyatli tasdiqlandi."
          data:
            student:
              id: 1
              email: "student@example.com"
              first_name: "Ali"
              last_name: "Valiyev"
              full_name: "Ali Valiyev"
              phone: "+998901234567"
              passport_serial_number: "AB1234567"
              birth_date: "2000-01-15"
              source: "instagram"
              source_display: "Instagram"
              group: null
              certificate: null
              contract: "/media/contracts/contract_1_20260110.pdf"
              contract_url: "http://localhost:8000/media/contracts/contract_1_20260110.pdf"
              contract_signed: true
              created_at: "2026-01-10T12:00:00Z"
              updated_at: "2026-01-10T12:00:00Z"
            contract_signed: true
      
      error_responses:
        - status_code: 400
          description: "Invalid verification code"
          schema:
            success: false
            message: "Noto'g'ri tasdiqlash kodi."
        - status_code: 400
          description: "Verification code expired"
          schema:
            success: false
            message: "Tasdiqlash kodi muddati tugagan. Iltimos, yangi kod so'rang."
        - status_code: 400
          description: "Contract already signed"
          schema:
            success: false
            message: "Shartnoma allaqachon tasdiqlangan."
        - status_code: 401
          description: "Authentication required"
        - status_code: 404
          description: "Student profile not found"
      
      notes:
        - "Kod faqat 2 daqiqa (yoki sozlangan vaqt) davomida amal qiladi"
        - "Kod tasdiqlangandan keyin o'chiriladi va qayta ishlatib bo'lmaydi"
        - "Shartnoma bir marta tasdiqlanishi mumkin"

    resend_verification_code:
      method: "POST"
      path: "/api/v1/auth/students/resend-code/"
      authentication_required: true
      description: "Shartnomani tasdiqlash uchun yangi kod yuborish"
      
      headers:
        Authorization: "Bearer <access_token>"
      
      note: "No request body required. The endpoint uses the authenticated student's phone number."
      
      success_response:
        status_code: 200
        description: "Yangi tasdiqlash kodi muvaffaqiyatli yuborildi."
        schema:
          success: true
          message: "Yangi tasdiqlash kodi muvaffaqiyatli yuborildi."
          data:
            message: "Yangi tasdiqlash kodi SMS orqali yuborildi."
            expires_at: "2026-01-10T12:02:00Z"
      
      error_responses:
        - status_code: 400
          description: "Contract already signed"
          schema:
            success: false
            message: "Shartnoma allaqachon tasdiqlangan."
        - status_code: 401
          description: "Authentication required"
        - status_code: 404
          description: "Student profile not found"
        - status_code: 500
          description: "SMS sending failed"
          schema:
            success: false
            message: "SMS yuborishda xatolik yuz berdi: <error_message>"
      
      notes:
        - "Yangi kod avvalgi kodni bekor qiladi"
        - "Kod SMS orqali talabaning telefon raqamiga yuboriladi"
        - "Test akkauntlar uchun kod API javobida ham qaytarilishi mumkin"

enums:
  employee_roles:
    description: "Employee Roles"
    values:
      - key: "dasturchi"
        display: "Dasturchi"
      - key: "direktor"
        display: "Direktor"
      - key: "administrator"
        display: "Administrator"
      - key: "sotuv_agenti"
        display: "Sotuv agenti"
      - key: "mentor"
        display: "Mentor"
      - key: "assistent"
        display: "Assistent"
      - key: "buxgalter"
        display: "Buxgalter"
  
  speciality_values:
    description: "Speciality Values (for Mentors only)"
    values:
      - key: "revit_architecture"
        display: "Revit Architecture"
      - key: "revit_structure"
        display: "Revit Structure"
      - key: "tekla_structure"
        display: "Tekla Structure"

response_format:
  success:
    schema:
      success: true
      message: "Operation successful message"
      data: {}  # Response data
  
  error:
    schema:
      success: false
      message: "Error message"
      errors: {}  # Field-specific errors (if applicable)
  
  note: |
    Some endpoints may return Django REST Framework's default error format
    for certain error types (e.g., 401 Unauthorized).

  student_booking:
    list_groups:
      method: "GET"
      path: "/api/v1/education/booking/groups/"
      authentication_required: false
      description: "List all groups with booking information including availability"
      
      success_response:
        status_code: 200
        data:
          - id: 1
            speciality_id: "revit_architecture"
            speciality_display: "Revit Architecture"
            dates: "mon_wed_fri"
            dates_display: "Monday - Wednesday - Friday"
            time: "14:00:00"
            starting_date: "2026-01-15"
            finish_date: "2026-08-15"
            total_lessons: 72
            current_lesson_number: 0
            seats: 15
            price: "3000000.00"
            current_students_count: 5
            available_seats: 10
            is_planned: true
            is_active: false
            can_accept_bookings: true
            days_since_start: null
            mentor: 1
            mentor_name: "John Doe"
    
    book_student:
      method: "POST"
      path: "/api/v1/education/booking/book/"
      authentication_required: false
      description: "Book a student into a group with validation (10-day rule)"
      
      request_body:
        type: "object"
        required_fields:
          - student_id
          - group_id
        schema:
          student_id: "integer (Student ID)"
          group_id: "integer (Group ID)"
      
      validation_rules:
        - "Student must exist and not already be booked"
        - "Group must have available seats"
        - "10-day rule: If group started, booking allowed only if < 10 days have passed"
      
      success_response:
        status_code: 201
        message: "Student booked successfully into the group."
        data:
          booking:
            student_id: 1
            student_name: "John Student"
            group: {}
      
      error_responses:
        no_seats:
          status_code: 400
          message: "No available seats in this group."
          data:
            alternatives: []
        ten_day_limit:
          status_code: 400
          message: "Cannot book this group. It started X days ago (10-day limit exceeded)."
          data:
            alternatives: []
        already_booked:
          status_code: 400
          message: "Student is already booked in another group."
    
    cancel_booking:
      method: "POST"
      path: "/api/v1/education/booking/cancel/"
      authentication_required: false
      description: "Cancel a student's booking by removing them from their group"
      
      request_body:
        type: "object"
        required_fields:
          - student_id
        schema:
          student_id: "integer (Student ID)"
      
      success_response:
        status_code: 200
        message: "Booking cancelled successfully."
        data:
          cancelled_booking:
            student_id: 1
            student_name: "John Student"
            group_id: 2
            group_name: "Revit Architecture - Monday - Wednesday - Friday"
      
      error_responses:
        no_booking:
          status_code: 400
          message: "Student has no active booking."
        not_found:
          status_code: 404
          message: "Student not found."

http_status_codes:
  200: "OK - Request successful"
  201: "Created - Resource created successfully"
  400: "Bad Request - Validation errors or invalid input"
  401: "Unauthorized - Authentication required or invalid token"
  404: "Not Found - Resource not found"
  500: "Internal Server Error - Server error"

notes:
  - "Students do NOT have login/registration endpoints as this is not an online learning platform. Students are managed through admin panel or by employees."
  - "All timestamps are in ISO 8601 format (UTC)."
  - "Avatar URLs are absolute URLs when available in request context."
  - "Password validation follows Django's default validators: Minimum length validation, Common password validation, Numeric password validation, User attribute similarity validation."
  - "JWT tokens are stored in memory on the client side. Access tokens should be refreshed before expiration to maintain session."
  - "All file uploads (avatars) should use multipart/form-data content type."
  - "The API uses API versioning (/api/v1/) for backward compatibility when new versions are released."
  - "Booking system implements 10-day rule: Groups that started >= 10 days ago cannot accept new bookings."

metadata:
  payment_apis:
    installment_system:
      description: |
        To make payments more accessible for students, the system uses a 2-installment
        payment plan based on lesson progress:
        - When a student books a group, TWO installment invoices are automatically created
        - Each installment is 50% of the total group price
        - Payment milestones are based on lesson numbers:
          * First installment: Must be paid by the midpoint lesson (e.g., lesson 36 if total is 72)
          * Second installment: Must be paid by the final lesson (e.g., lesson 72)
        - Students can pay installments separately at their convenience
        - Payment is tied to lesson progress, not dates, allowing flexibility for rescheduled lessons
        - Both installments must be paid for full course access
      
      lesson_and_date_information: |
        - Administrators set total_lessons (e.g., 72 lessons) for each group
        - When starting_date and total_lessons are set, finish_date is automatically calculated
        - Finish date calculation is based on lesson schedule:
          * Mon/Wed/Fri groups: Lessons on Monday, Wednesday, Friday (3 per week)
          * Tue/Thu/Sat groups: Lessons on Tuesday, Thursday, Saturday (3 per week)
        - Current lesson number is tracked from attendance records
        - Students can see: finish_date, total_lessons, and current_lesson_number in group information
      
      example:
        group_price: 3000000
        total_lessons: 72
        installment_1:
          amount: 1500000
          payment_milestone_lesson: 36
        installment_2:
          amount: 1500000
          payment_milestone_lesson: 72
    
    list_invoices:
      method: "GET"
      path: "/api/v1/payment/invoices/"
      authentication_required: true
      description: "List all invoices. Students can see only their own invoices. Staff/admin can see all invoices."
      
      headers:
        Authorization: "Bearer <access_token>"
        Content-Type: "application/json"
      
      query_parameters: []
      
      success_response:
        status_code: 200
        schema:
          type: "array"
          items:
            type: "object"
            properties:
              id: { type: "integer" }
              student: { type: "integer" }
              student_name: { type: "string" }
              student_phone: { type: "string" }
              group: { type: "integer" }
              group_name: { type: "string" }
              amount: { type: "string", format: "decimal", description: "Installment amount (50% of total)" }
              total_amount: { type: "string", format: "decimal", nullable: true, description: "Total group price" }
              installment_number: { type: "integer", nullable: true, enum: [1, 2], description: "Installment number (1 or 2)" }
              is_installment: { type: "boolean", description: "Whether this is an installment invoice" }
              related_invoice_id: { type: "integer", nullable: true, description: "ID of the other installment invoice" }
              status: { type: "string", enum: ["created", "pending", "paid", "cancelled", "refunded", "expired"] }
              status_display: { type: "string" }
              is_paid: { type: "boolean" }
              payment_progress:
                type: "object"
                description: "Payment progress information for installment invoices"
                properties:
                  is_installment: { type: "boolean" }
                  installment_1_paid: { type: "boolean", nullable: true }
                  installment_2_paid: { type: "boolean", nullable: true }
                  total_amount: { type: "number" }
                  paid_amount: { type: "number" }
                  remaining_amount: { type: "number" }
                  all_paid: { type: "boolean", nullable: true }
              multicard_uuid: { type: "string", nullable: true }
              multicard_invoice_id: { type: "string", nullable: true }
              checkout_url: { type: "string", format: "uri", nullable: true }
              receipt_url: { type: "string", format: "uri", nullable: true }
              payment_time: { type: "string", format: "date-time", nullable: true }
              payment_method: { type: "string", nullable: true }
              card_pan: { type: "string", nullable: true }
              notes: { type: "string", nullable: true }
              created_at: { type: "string", format: "date-time" }
              updated_at: { type: "string", format: "date-time" }
      
      error_responses:
        - status_code: 401
          description: "Invalid or missing authentication token"
        - status_code: 403
          description: "User does not have permission to view invoices"
    
    get_invoice_details:
      method: "GET"
      path: "/api/v1/payment/invoices/<id>/"
      authentication_required: true
      description: "Get detailed information about a specific invoice."
      
      headers:
        Authorization: "Bearer <access_token>"
        Content-Type: "application/json"
      
      url_parameters:
        id:
          type: "integer"
          description: "Invoice ID"
          required: true
      
      success_response:
        status_code: 200
        schema:
          type: "object"
          properties:
            id: { type: "integer" }
            student: { type: "integer" }
            student_name: { type: "string" }
            student_phone: { type: "string" }
            group: { type: "integer" }
            group_name: { type: "string" }
            amount: { type: "string", format: "decimal", description: "Installment amount (50% of total)" }
            total_amount: { type: "string", format: "decimal", nullable: true, description: "Total group price" }
            installment_number: { type: "integer", nullable: true, enum: [1, 2], description: "Installment number (1 or 2)" }
            is_installment: { type: "boolean", description: "Whether this is an installment invoice" }
            related_invoice_id: { type: "integer", nullable: true, description: "ID of the other installment invoice" }
            status: { type: "string" }
            status_display: { type: "string" }
            is_paid: { type: "boolean" }
            payment_progress:
              type: "object"
              description: "Payment progress information for installment invoices"
              properties:
                is_installment: { type: "boolean" }
                installment_1_paid: { type: "boolean", nullable: true }
                installment_2_paid: { type: "boolean", nullable: true }
                total_amount: { type: "number" }
                paid_amount: { type: "number" }
                remaining_amount: { type: "number" }
                all_paid: { type: "boolean", nullable: true }
            multicard_uuid: { type: "string", nullable: true }
            multicard_invoice_id: { type: "string", nullable: true }
            checkout_url: { type: "string", format: "uri", nullable: true }
            receipt_url: { type: "string", format: "uri", nullable: true }
            payment_time: { type: "string", format: "date-time", nullable: true }
            payment_method: { type: "string", nullable: true }
            card_pan: { type: "string", nullable: true }
            notes: { type: "string", nullable: true }
            created_at: { type: "string", format: "date-time" }
            updated_at: { type: "string", format: "date-time" }
      
      error_responses:
        - status_code: 401
          description: "Invalid or missing authentication token"
        - status_code: 403
          description: "User does not have permission to view this invoice"
        - status_code: 404
          description: "Invoice not found"
    
    create_payment_link:
      method: "POST"
      path: "/api/v1/payment/create-payment/"
      authentication_required: true
      description: "Create a payment link for an invoice via Multicard payment gateway."
      
      headers:
        Authorization: "Bearer <access_token>"
        Content-Type: "application/json"
      
      request_body:
        type: "object"
        required_fields:
          - invoice_id
        optional_fields:
          - lang
          - return_url
          - return_error_url
          - send_sms
        schema:
          invoice_id:
            type: "integer"
            description: "ID of the invoice to pay"
          lang:
            type: "string"
            enum: ["ru", "uz", "en"]
            default: "uz"
            description: "Payment page language"
          return_url:
            type: "string"
            format: "uri"
            description: "URL to redirect after successful payment"
          return_error_url:
            type: "string"
            format: "uri"
            description: "URL to redirect after payment error"
          send_sms:
            type: "boolean"
            default: false
            description: "Send invoice link via SMS to student"
      
      success_response:
        status_code: 200
        schema:
          type: "object"
          properties:
            success: { type: "boolean" }
            data:
              type: "object"
              properties:
                checkout_url: { type: "string", format: "uri" }
                short_link: { type: "string", format: "uri" }
                deeplink: { type: "string", format: "uri" }
                uuid: { type: "string" }
                invoice_id: { type: "integer" }
            message: { type: "string" }
      
      error_responses:
        - status_code: 400
          description: "Invoice is already paid, cancelled, or failed to create payment link"
        - status_code: 401
          description: "Invalid or missing authentication token"
        - status_code: 403
          description: "User does not have permission to pay this invoice"
        - status_code: 404
          description: "Invoice not found"
        - status_code: 500
          description: "Server error during payment link creation"
    
    check_invoice_status:
      method: "GET"
      path: "/api/v1/payment/check-status/"
      authentication_required: true
      description: "Check the current payment status of an invoice from Multicard."
      
      headers:
        Authorization: "Bearer <access_token>"
        Content-Type: "application/json"
      
      query_parameters:
        invoice_id:
          type: "integer"
          required: true
          description: "Invoice ID to check"
      
      success_response:
        status_code: 200
        schema:
          type: "object"
          properties:
            success: { type: "boolean" }
            data:
              type: "object"
              properties:
                invoice_id: { type: "integer" }
                status: { type: "string" }
                multicard_status: { type: "string" }
                checkout_url: { type: "string", format: "uri", nullable: true }
                receipt_url: { type: "string", format: "uri", nullable: true }
                payment_time: { type: "string", format: "date-time", nullable: true }
      
      error_responses:
        - status_code: 400
          description: "invoice_id parameter is required or failed to get status"
        - status_code: 401
          description: "Invalid or missing authentication token"
        - status_code: 403
          description: "User does not have permission to view this invoice"
        - status_code: 404
          description: "Invoice not found"
    
    payment_callback:
      method: "POST"
      path: "/api/v1/payment/callback/"
      authentication_required: false
      description: "Internal endpoint that receives payment callbacks from Multicard. Called automatically by Multicard."
      
      headers:
        Content-Type: "application/json"
      
      request_body:
        type: "object"
        required_fields:
          - store_id
          - amount
          - invoice_id
          - billing_id
          - payment_time
          - uuid
          - sign
        schema:
          store_id: { type: "integer" }
          amount: { type: "integer", description: "Amount in tiyins" }
          invoice_id: { type: "string" }
          billing_id: { type: "string" }
          payment_time: { type: "string" }
          phone: { type: "string", nullable: true }
          card_pan: { type: "string", nullable: true }
          ps: { type: "string", nullable: true }
          card_token: { type: "string", nullable: true }
          uuid: { type: "string" }
          receipt_url: { type: "string", format: "uri", nullable: true }
          sign: { type: "string", description: "MD5 signature for verification" }
      
      success_response:
        status_code: 200
        schema:
          type: "object"
          properties:
            success: { type: "boolean" }
            message: { type: "string" }
      
      error_responses:
        - status_code: 400
          description: "Invalid callback data or signature"
        - status_code: 404
          description: "Invoice not found"
        - status_code: 500
          description: "Server error processing callback"
      
      note: "This endpoint is called automatically by Multicard. It should not be called manually by clients."
    
    payment_webhook:
      method: "POST"
      path: "/api/v1/payment/webhook/"
      authentication_required: false
      description: "Internal endpoint that receives webhook notifications from Multicard for payment status changes."
      
      headers:
        Content-Type: "application/json"
      
      request_body:
        type: "object"
        required_fields:
          - uuid
          - amount
          - invoice_id
          - status
          - billing_id
          - payment_time
          - sign
        schema:
          uuid: { type: "string" }
          amount: { type: "integer", description: "Amount in tiyins" }
          invoice_id: { type: "string" }
          status: { type: "string", enum: ["draft", "progress", "success", "error", "revert", "hold"] }
          billing_id: { type: "string" }
          payment_time: { type: "string" }
          refund_time: { type: "string", nullable: true }
          phone: { type: "string", nullable: true }
          card_pan: { type: "string", nullable: true }
          ps: { type: "string", nullable: true }
          card_token: { type: "string", nullable: true }
          receipt_url: { type: "string", format: "uri", nullable: true }
          sign: { type: "string", description: "SHA1 signature for verification" }
      
      success_response:
        status_code: 200
        schema:
          type: "object"
          properties:
            success: { type: "boolean" }
            message: { type: "string" }
      
      error_responses:
        - status_code: 400
          description: "Incomplete webhook data or invalid signature"
        - status_code: 404
          description: "Invoice not found"
        - status_code: 500
          description: "Server error processing webhook"
      
      note: "This endpoint is called automatically by Multicard. It should not be called manually by clients."
    
    invoice_status_values:
      - "created: Invoice created but payment link not generated yet"
      - "pending: Payment link created, waiting for payment"
      - "paid: Payment completed successfully"
      - "cancelled: Invoice cancelled"
      - "refunded: Payment refunded"
      - "expired: Invoice expired"
    
    automatic_invoice_generation:
      description: |
        Two installment invoices are automatically generated when:
        1. A student books a group (student.group is set)
        2. The group has a price set (price > 0)
      
      installment_details: |
        Each installment invoice:
        - Represents 50% of the total group price
        - Has a payment_milestone_lesson indicating when payment is required:
          * First installment: milestone = midpoint lesson (e.g., lesson 36 if total is 72)
          * Second installment: milestone = final lesson (e.g., lesson 72)
        - Can be paid independently
        - Payment is required before reaching the milestone lesson
      
      example:
        group_price: 3000000
        total_lessons: 72
        invoice_1:
          amount: 1500000
          payment_milestone_lesson: 36
        invoice_2:
          amount: 1500000
          payment_milestone_lesson: 72
        note: "Students can continue lessons before the milestone, but must pay before reaching it"
    
    automatic_price_updates:
      description: |
        When a group's price changes:
        - Unpaid installment invoices (created/pending status) are automatically updated
          with the new price, maintaining the 50/50 split
        - Both installments are updated proportionally
        - Paid invoices are NOT updated (amount remains as paid)
    
    payment_progress_tracking:
      description: |
        Each installment invoice includes a payment_progress object that shows:
        - is_installment: true (indicates this is an installment invoice)
        - installment_1_paid: boolean (whether first installment is paid)
        - installment_2_paid: boolean (whether second installment is paid)
        - total_amount: float (total group price)
        - paid_amount: float (sum of all paid installments)
        - remaining_amount: float (amount still to be paid)
        - all_paid: boolean (whether both installments are paid)
        - payment_milestone_lesson: integer (lesson number by which this installment must be paid)
        - second_milestone_lesson: integer (lesson number for the other installment)
        - current_lesson: integer (current lesson number from attendance records)
        - total_lessons: integer (total number of lessons in the group)
        - lessons_remaining: integer (number of lessons remaining)

  last_updated: "2026-01-12"
  apis_documented:
    - "Employee Registration (POST /api/v1/auth/register/)"
    - "Employee Login (POST /api/v1/auth/login/)"
    - "Employee Profile - Get (GET /api/v1/auth/profile/)"
    - "Employee Profile - Update (PATCH /api/v1/auth/profile/)"
    - "Token Refresh (POST /api/v1/auth/token/refresh/)"
    - "Employee Management - List (GET /api/v1/auth/employees/)"
    - "Employee Management - Get (GET /api/v1/auth/employees/<id>/)"
    - "Employee Management - Update (PATCH/PUT /api/v1/auth/employees/<id>/)"
    - "Groups - List (GET /api/v1/education/groups/)"
    - "Groups - Create (POST /api/v1/education/groups/)"
    - "Groups - Get (GET /api/v1/education/groups/<id>/)"
    - "Groups - Update (PATCH/PUT /api/v1/education/groups/<id>/)"
    - "Groups - Delete (DELETE /api/v1/education/groups/<id>/)"
    - "Attendances - List (GET /api/v1/education/attendances/)"
    - "Attendances - Create (POST /api/v1/education/attendances/)"
    - "Attendances - Get (GET /api/v1/education/attendances/<id>/)"
    - "Attendances - Update (PATCH/PUT /api/v1/education/attendances/<id>/)"
    - "Attendances - Delete (DELETE /api/v1/education/attendances/<id>/)"
    - "Booking - List Groups (GET /api/v1/education/booking/groups/)"
    - "Booking - Book Student (POST /api/v1/education/booking/book/)"
    - "Booking - Cancel Booking (POST /api/v1/education/booking/cancel/)"
    - "Payment - List Invoices (GET /api/v1/payment/invoices/)"
    - "Payment - Get Invoice Details (GET /api/v1/payment/invoices/<id>/)"
    - "Payment - Create Payment Link (POST /api/v1/payment/create-payment/)"
    - "Payment - Check Invoice Status (GET /api/v1/payment/check-status/)"
    - "Payment - Callback (POST /api/v1/payment/callback/) - Internal"
    - "Payment - Webhook (POST /api/v1/payment/webhook/) - Internal"
  documentation_version: "1.0"
